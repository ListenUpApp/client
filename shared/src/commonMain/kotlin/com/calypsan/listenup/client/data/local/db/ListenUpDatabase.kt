package com.calypsan.listenup.client.data.local.db

import androidx.room.ConstructedBy
import androidx.room.Database
import androidx.room.RoomDatabase
import androidx.room.RoomDatabaseConstructor
import androidx.room.TypeConverters

/**
 * Room database for ListenUp client.
 *
 * Stores user data, books, and sync metadata for offline-first functionality.
 *
 * Schema versioning:
 * - v1: Initial schema with UserEntity only
 * - v2: Added BookEntity and SyncMetadataEntity for sync support
 * - v3: Added ChapterEntity
 * - v8: Added subtitle column to books table
 * - v9: Added FTS5 tables for full-text search (books_fts, contributors_fts, series_fts)
 * - v10: Added book_series junction table for many-to-many book-series relationships
 * - v11: Added publisher, language, isbn, asin, abridged columns to books table
 * - v12: Added website, birthDate, deathDate, aliases columns to contributors; creditedAs to book_contributors
 * - v13: Added servers table for multi-server support with per-server auth tokens
 * - v17: Added collections table for admin collection management
 * - v18: Added lenses table for personal curation and social discovery
 * - v19: Added tags and book_tags tables for community tagging
 * - v20: Added lastPlayedAt column to playback_positions for accurate "last read" tracking
 * - v21: Added listening_events table for offline-first stats
 * - v22: Added avatarType, avatarValue, avatarColor columns to users table
 * - v23: Added tagline column to users table for profile bio
 * - v24: Added user_profiles table for caching other users' profile data
 * - v25: Added active_sessions table for "What Others Are Listening To" feature
 * - v26: Added activities table for offline activity feed
 * - v27: Added user_stats table for offline leaderboard caching
 *
 * Migration strategy: Manual migrations provided for all version transitions
 * to preserve user data. Destructive migration disabled.
 */
@Database(
    entities = [
        UserEntity::class,
        UserProfileEntity::class,
        BookEntity::class,
        SyncMetadataEntity::class,
        ChapterEntity::class,
        SeriesEntity::class,
        ContributorEntity::class,
        BookContributorCrossRef::class,
        BookSeriesCrossRef::class,
        PlaybackPositionEntity::class,
        PendingOperationEntity::class,
        DownloadEntity::class,
        ServerEntity::class,
        CollectionEntity::class,
        LensEntity::class,
        TagEntity::class,
        BookTagCrossRef::class,
        ListeningEventEntity::class,
        ActiveSessionEntity::class,
        ActivityEntity::class,
        UserStatsEntity::class,
    ],
    version = 27,
    exportSchema = true,
)
@TypeConverters(ValueClassConverters::class, Converters::class, PendingOperationConverters::class)
@ConstructedBy(ListenUpDatabaseConstructor::class)
abstract class ListenUpDatabase : RoomDatabase() {
    abstract fun userDao(): UserDao

    abstract fun userProfileDao(): UserProfileDao

    abstract fun bookDao(): BookDao

    abstract fun syncDao(): SyncDao

    abstract fun chapterDao(): ChapterDao

    abstract fun seriesDao(): SeriesDao

    abstract fun contributorDao(): ContributorDao

    abstract fun bookContributorDao(): BookContributorDao

    abstract fun bookSeriesDao(): BookSeriesDao

    abstract fun playbackPositionDao(): PlaybackPositionDao

    abstract fun pendingOperationDao(): PendingOperationDao

    abstract fun downloadDao(): DownloadDao

    abstract fun searchDao(): SearchDao

    abstract fun serverDao(): ServerDao

    abstract fun collectionDao(): CollectionDao

    abstract fun lensDao(): LensDao

    abstract fun tagDao(): TagDao

    abstract fun listeningEventDao(): ListeningEventDao

    abstract fun activeSessionDao(): ActiveSessionDao

    abstract fun activityDao(): ActivityDao

    abstract fun userStatsDao(): UserStatsDao
}

/**
 * Room database constructor for KMP.
 * The expect declaration is needed for commonMain compilation.
 * The actual implementations are generated by Room KSP for each platform (Android, iOS).
 */
@Suppress("NO_ACTUAL_FOR_EXPECT", "EXPECT_ACTUAL_CLASSIFIERS_ARE_IN_BETA_WARNING")
expect object ListenUpDatabaseConstructor : RoomDatabaseConstructor<ListenUpDatabase> {
    override fun initialize(): ListenUpDatabase
}
