package com.calypsan.listenup.client.data.local.db

import androidx.room.ConstructedBy
import androidx.room.Database
import androidx.room.RoomDatabase
import androidx.room.RoomDatabaseConstructor
import androidx.room.TypeConverters

/**
 * Room database for ListenUp client.
 *
 * Stores user data, books, and sync metadata for offline-first functionality.
 *
 * Schema reset to version 1 â€” no prior users exist, so all legacy migrations
 * (v1-v38) were removed. The current schema is the v1 baseline.
 *
 * Destructive migration enabled as a safety net during early development.
 */
@Database(
    entities = [
        UserEntity::class,
        UserProfileEntity::class,
        BookEntity::class,
        SyncMetadataEntity::class,
        ChapterEntity::class,
        SeriesEntity::class,
        ContributorEntity::class,
        BookContributorCrossRef::class,
        BookSeriesCrossRef::class,
        PlaybackPositionEntity::class,
        PendingOperationEntity::class,
        DownloadEntity::class,
        ServerEntity::class,
        CollectionEntity::class,
        ShelfEntity::class,
        ShelfBookCrossRef::class,
        TagEntity::class,
        BookTagCrossRef::class,
        GenreEntity::class,
        BookGenreCrossRef::class,
        ListeningEventEntity::class,
        ActiveSessionEntity::class,
        ActivityEntity::class,
        UserStatsEntity::class,
        ReadingSessionEntity::class,
        CoverDownloadTaskEntity::class,
    ],
    version = 1,
    exportSchema = true,
)
@TypeConverters(
    ValueClassConverters::class,
    Converters::class,
    PendingOperationConverters::class,
    StringListConverter::class,
    CoverDownloadStatusConverter::class,
)
@ConstructedBy(ListenUpDatabaseConstructor::class)
@Suppress("TooManyFunctions")
abstract class ListenUpDatabase : RoomDatabase() {
    abstract fun userDao(): UserDao

    abstract fun userProfileDao(): UserProfileDao

    abstract fun bookDao(): BookDao

    abstract fun syncDao(): SyncDao

    abstract fun chapterDao(): ChapterDao

    abstract fun seriesDao(): SeriesDao

    abstract fun contributorDao(): ContributorDao

    abstract fun bookContributorDao(): BookContributorDao

    abstract fun bookSeriesDao(): BookSeriesDao

    abstract fun playbackPositionDao(): PlaybackPositionDao

    abstract fun pendingOperationDao(): PendingOperationDao

    abstract fun downloadDao(): DownloadDao

    abstract fun searchDao(): SearchDao

    abstract fun serverDao(): ServerDao

    abstract fun collectionDao(): CollectionDao

    abstract fun shelfDao(): ShelfDao

    abstract fun shelfBookDao(): ShelfBookDao

    abstract fun tagDao(): TagDao

    abstract fun genreDao(): GenreDao

    abstract fun listeningEventDao(): ListeningEventDao

    abstract fun activeSessionDao(): ActiveSessionDao

    abstract fun activityDao(): ActivityDao

    abstract fun userStatsDao(): UserStatsDao

    abstract fun readingSessionDao(): ReadingSessionDao

    abstract fun coverDownloadDao(): CoverDownloadDao
}

/**
 * Room database constructor for KMP.
 * The expect declaration is needed for commonMain compilation.
 * The actual implementations are generated by Room KSP for each platform (Android, iOS).
 */
@Suppress("NO_ACTUAL_FOR_EXPECT", "EXPECT_ACTUAL_CLASSIFIERS_ARE_IN_BETA_WARNING")
expect object ListenUpDatabaseConstructor : RoomDatabaseConstructor<ListenUpDatabase> {
    override fun initialize(): ListenUpDatabase
}
